<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Windows 12</title>
<style>
  *{box-sizing:border-box;margin:0;padding:0;font-family: "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; user-select:none}
  html,body{height:100%;width:100%;overflow:hidden;background:#111;}
  /* Body locked class hides UI immediately to avoid flash */
  body.locked { overflow: hidden; }
  body.locked .window,
  body.locked .taskbar,
  body.locked .start-menu,
  body.locked .desktop { visibility: hidden; }

  .wallpaper { position:absolute; inset:0; background: url("WALLPEPPA.jpeg") center/cover no-repeat; z-index:0; }

  /* DESKTOP (UPDATED: absolute-positioned draggable icons with grid snapping) */
  .desktop{
    position:absolute; inset:0; z-index:10; pointer-events:auto;
    display:block;
    padding:32px;
  }

  /* We'll place icons absolutely inside .desktop-inner which fills the desktop */
  .desktop-inner {
    position: absolute;
    inset: 0;
  }

  /* Desktop icon visual (kept same) */
  .icon {
    position: absolute; /* now absolute */
    width:96px; height:110px; display:flex; flex-direction:column; align-items:center; justify-content:flex-start; gap:8px; cursor:grab;
    user-select:none; color:#e9f0ff;
    touch-action: none;
    transition: box-shadow 140ms, transform 120ms;
  }
  .icon .ico {
    width:64px; height:64px; border-radius:12px; display:grid; place-items:center; background:rgba(255,255,255,0.06);
    font-size:28px;
  }
  .icon .label {
    font-size:13px; text-align:center; color:#fff; text-shadow:0 2px 6px rgba(0,0,0,0.45); max-width:86px; white-space:normal; word-wrap:break-word;
  }
  .icon.selected .ico { outline:2px solid rgba(255,255,255,0.18); box-shadow:0 6px 20px rgba(0,0,0,0.45); }
  .icon.selected .label { background:rgba(0,0,0,0.45); padding:2px 6px; border-radius:6px; color:#fff; font-weight:600; }

  /* dragging state */
  .icon.dragging { opacity:0.9; transform:scale(1.02); cursor:grabbing; z-index:1200; box-shadow:0 30px 80px rgba(2,6,23,0.6); }

  /* CONTEXT MENU */
  .ctx-menu {
    position: fixed;
    min-width: 160px;
    background: #fff;
    color: #0b253a;
    border-radius:8px;
    box-shadow: 0 12px 40px rgba(2,6,23,0.45);
    border: 1px solid rgba(0,0,0,0.06);
    z-index: 1200;
    display: none;
    padding:6px 6px;
    font-size:14px;
  }
  .ctx-menu button {
    display:block;
    width:100%;
    text-align:left;
    padding:8px 10px;
    border:0;
    background:transparent;
    cursor:pointer;
    border-radius:6px;
  }
  .ctx-menu button:hover { background: rgba(0,0,0,0.04); }

  /* LOGIN SCREEN (ADDED) */
  #loginScreen {
    position: fixed;
    inset: 0;
    z-index: 9999;
    display: flex;
    align-items: center;
    justify-content: center;
    background: url("WALLPEPPA.jpeg") center/cover no-repeat;
    background-size: cover;
  }
  #loginCard {
    width: 420px;
    max-width: 92%;
    padding: 28px;
    border-radius: 12px;
    background: rgba(2,6,23,0.48);
    box-shadow: 0 24px 80px rgba(2,6,23,0.7);
    border: 1px solid rgba(255,255,255,0.04);
    display:flex;
    flex-direction:column;
    align-items:center;
    gap:14px;
    color:#fff;
  }
  .login-photo{ width:120px;height:120px;border-radius:999px;overflow:hidden;border:4px solid rgba(255,255,255,0.08);display:grid;place-items:center;background:#eee; }
  .login-photo img{ width:100%;height:100%;object-fit:cover;display:block; }
  .login-name{ font-size:20px;font-weight:700;color:#fff;text-shadow:0 2px 6px rgba(0,0,0,0.45) }
  .login-sub{ font-size:13px;color:rgba(255,255,255,0.85);margin-top:-6px }
  .pin-input { width:100%; max-width:360px; display:flex; flex-direction:column; gap:8px; }
  .pin-input input{
    width:100%;
    padding:12px 14px;
    border-radius:8px;
    border:1px solid rgba(255,255,255,0.06);
    background: rgba(0,0,0,0.35);
    color:#fff;
    font-size:16px;
    outline:none;
    text-align:center;
  }
  .pin-actions{ display:flex; gap:8px; width:100%; justify-content:center; margin-top:6px; }
  .btn-ghost{ padding:8px 12px; border-radius:8px; background:transparent; border:1px solid rgba(255,255,255,0.08); color:#fff; cursor:pointer }
  .btn-primary{ padding:8px 12px; border-radius:8px; background:linear-gradient(180deg,#0b84ff,#0463d6); border:0; color:#fff; cursor:pointer }
  .login-hint{ font-size:12px; color:rgba(255,255,255,0.75); margin-top:6px }

  /* Taskbar (kept simple) */
  .taskbar{position:absolute;left:0;right:0;bottom:0;height:55px;background:rgba(255,255,255,0.20);backdrop-filter:blur(16px);display:flex;align-items:center;padding:6px 12px;gap:12px;z-index:50}
  .taskbar-left{display:flex;gap:8px;align-items:center}
  .taskbar-icon{width:44px;height:44px;border-radius:8px;display:grid;place-items:center;background:rgba(255,255,255,0.12);cursor:pointer}
  .taskbar-icon.active{box-shadow:0 8px 18px rgba(0,0,0,0.5);background:rgba(255,255,255,0.22)}
  .taskbar-pin { width:40px;height:40px;border-radius:8px;display:grid;place-items:center;background:rgba(0,0,0,0.05);cursor:pointer;margin-left:6px; }

  /* Notes Window (unchanged) */
  .window{position:absolute;left:80px;top:60px;width:900px;height:600px;border-radius:12px;overflow:hidden;background:linear-gradient(180deg,rgba(255,255,255,0.98),#fbfbff);box-shadow:0 20px 60px rgba(2,6,23,0.7);border:1px solid rgba(0,0,0,0.06);display:flex;flex-direction:column;z-index:40}
  .titlebar{height:48px;display:flex;align-items:center;justify-content:space-between;padding:0 12px;background:linear-gradient(180deg,rgba(255,255,255,0.98),#f7f7fb);cursor:grab}
  .title-left{display:flex;align-items:center;gap:12px}
  .title-left .badge{width:36px;height:36px;border-radius:8px;display:grid;place-items:center;background:linear-gradient(180deg,#f59e0b,#f97316);color:white;font-weight:700}
  .win-controls{display:flex;gap:8px;align-items:center}
  .win-btn{width:36px;height:30px;border-radius:6px;display:grid;place-items:center;cursor:pointer}
  .win-btn:hover{background:rgba(0,0,0,0.03)}
  .content{flex:1;display:flex;height:100%;min-height:0} /* min-height:0 for flexbox overflow */

  /* Sidebar (notes list) */
  .sidebar{width:320px;border-right:1px solid rgba(0,0,0,0.04);display:flex;flex-direction:column;background:linear-gradient(180deg,#fff,#fbfbff)}
  .sb-top{padding:12px;border-bottom:1px solid rgba(0,0,0,0.03);display:flex;flex-direction:column;gap:8px}
  .sb-actions{display:flex;gap:8px;align-items:center}
  .btn{padding:8px 10px;border-radius:8px;background:rgba(0,0,0,0.03);cursor:pointer;font-size:13px}
  .btn.primary{background:#007aff;color:white}
  .search{display:flex;align-items:center;gap:8px;padding:8px;border-radius:10px;border:1px solid rgba(0,0,0,0.04);background:#fafafa}
  .search input{border:0;outline:none;background:transparent;font-size:14px;width:100%}
  .note-list{overflow:auto;flex:1;padding:6px}
  .note-item{display:flex;flex-direction:column;padding:10px;border-radius:8px;cursor:pointer;gap:6px}
  .note-item:hover{background:rgba(0,0,0,0.03)}
  .note-item.active{background:linear-gradient(180deg,#f1f9ff,#e6f4ff);box-shadow:inset 0 0 0 1px rgba(0,122,255,0.08)}
  .note-title{font-weight:600;color:#082a4a}
  .note-snippet{font-size:13px;color:#3b556f;opacity:0.85}
  .note-meta{font-size:12px;color:#556b88}

  /* Editor (right) */
  .editor{flex:1;display:flex;flex-direction:column;min-width:0}
  .editor-toolbar{height:56px;display:flex;align-items:center;gap:8px;padding:8px 12px;border-bottom:1px solid rgba(0,0,0,0.04);background:linear-gradient(180deg,#fff,#fbfbff)}
  .editor-body{flex:1;overflow:auto;padding:18px}
  .note-title-input{font-size:20px;font-weight:700;border:0;outline:none;padding:6px 0;width:100%;background:transparent}
  .note-textarea{width:100%;height:calc(100% - 46px);border:0;outline:none;resize:none;padding:12px 6px;font-size:15px;line-height:1.5;background:transparent;font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial}
  .empty-state{display:flex;align-items:center;justify-content:center;height:100%;color:#66799a;font-size:16px}

  /* Locked state: blur editor inner content */
  .editor-locked { filter: blur(4px); }

  /* Resizer */
  .resizer{position:absolute;right:10px;bottom:10px;width:12px;height:12px;cursor:se-resize}

  /* FULLSCREEN STYLE (minimal and non-invasive) */
  .window.fullscreen {
    left: 0 !important;
    top: 0 !important;
    width: 100vw !important;
    height: calc(100vh - 55px) !important; /* leave taskbar visible */
    border-radius: 0 !important;
    overflow: hidden !important;
  }
  .window.fullscreen .resizer { display: none !important; }
  .window.fullscreen .titlebar { cursor: default; }

  /* Start menu (new additions earlier) */
  .start-menu {
    position: absolute;
    bottom: 62px; /* sits slightly above the taskbar */
    left: 12px;   /* align with Start button area (tweak if needed) */
    width: 880px;
    height: 520px;
    background: linear-gradient(180deg,#ffffffee,#f5f7fb);
    border-radius: 12px;
    box-shadow: 0 30px 80px rgba(2,6,23,0.6);
    border: 1px solid rgba(0,0,0,0.06);
    display: none;
    z-index: 200;
    overflow: hidden;
    color: #0b253a;
    backdrop-filter: blur(6px);
  }

  .start-inner { display:flex; height:100%; }
  .start-left {
    width: 260px;
    border-right: 1px solid rgba(0,0,0,0.04);
    background: linear-gradient(180deg,#f7fafc,#fff);
    padding: 16px;
    display:flex;
    flex-direction:column;
    gap:12px;
  }
  .start-search {
    display:flex; align-items:center; gap:8px;
    background:#fff; border-radius:8px; padding:8px; border:1px solid rgba(0,0,0,0.04);
  }
  .start-search input{ border:0; outline:none; width:100%; font-size:14px; background:transparent; }
  .start-profile { display:flex; align-items:center; gap:10px; padding-top:6px; }
  .profile-pic { width:40px; height:40px; border-radius:999px; background:linear-gradient(180deg,#e6eefb,#d9e6ff); display:grid; place-items:center; font-weight:700; color:#11477a; }
  .app-list { flex:1; overflow:auto; padding-right:6px; margin-top:6px; }
  .app-list .app-item { display:flex; align-items:center; gap:12px; padding:8px 6px; border-radius:6px; cursor:pointer; color:#123145; font-size:14px; }
  .app-list .app-item:hover { background: rgba(0,0,0,0.03); }

  .start-right { flex:1; padding:18px; display:flex; flex-direction:column; gap:12px; }
  .tiles-grid { display:grid; grid-template-columns: repeat(4, 1fr); gap:12px; }
  .tile {
    height:76px; border-radius:8px; display:flex; flex-direction:column; align-items:flex-start; justify-content:center; padding:10px; color:white; font-weight:600; box-shadow: inset 0 -30px 40px rgba(0,0,0,0.06);
  }
  .tile.small { height:76px; }
  .tile .t-icon { width:34px; height:34px; border-radius:8px; display:grid; place-items:center; margin-bottom:6px; background:rgba(255,255,255,0.12); }
  .tile.office{ background: linear-gradient(180deg,#2b6dde,#1f4fd3); }
  .tile.edge{ background: linear-gradient(180deg,#0ea5a5,#028f8f); }
  .tile.photos{ background: linear-gradient(180deg,#6b21a8,#8b5cf6); }
  .tile.netflix{ background: linear-gradient(180deg,#111827,#ef4444); }
  .tile.store{ background: linear-gradient(180deg,#0ea5a5,#1fb5b5); color:#042f2f; }
  .tile.spotify{ background: linear-gradient(180deg,#1db954,#1db954); }

  .start-footer { display:flex; justify-content:space-between; font-size:12px; color:#4b657a; padding-top:6px; }

  /* small screens */
  @media (max-width:1000px){
    .start-menu { left: 8px; right:8px; width:auto; }
    .tiles-grid { grid-template-columns: repeat(3, 1fr); }
  }

  /* Responsive (existing) */
  @media (max-width:960px){
    .window{left:8px;top:8px;right:8px;width:calc(100% - 16px);height:calc(100% - 80px)}
    .sidebar{width:260px}
  }
</style>
</head>

<!-- NOTE: body starts locked to prevent any UI flash; JS will remove 'locked' after successful login -->
<body class="locked">

<!-- Context menu -->
<div id="ctxMenu" class="ctx-menu" role="menu" aria-hidden="true">
  <button id="ctxOpen">Open</button>
  <button id="ctxPin">Pin to taskbar</button>
</div>

<!-- LOGIN SCREEN (ADDED) -->
<div id="loginScreen" role="dialog" aria-modal="true" aria-label="Sign in">
  <div id="loginCard" role="document" aria-labelledby="loginName">
    <div class="login-photo" aria-hidden="false">
      <img src="profile.png" alt="Profile photo" />
    </div>
    <div style="text-align:center">
      <div id="loginName" class="login-name">1ScratchfromScratch</div>
      <div class="login-sub">Enter your PIN to sign in</div>
    </div>

    <div class="pin-input" style="width:100%">
      <input id="pinInput" type="password" inputmode="numeric" placeholder="PIN" aria-label="PIN" autocomplete="off" />
      <div class="pin-actions">
        <button id="pinCancel" class="btn-ghost" type="button">Cancel</button>
        <button id="pinSubmit" class="btn-primary" type="button">Sign in</button>
      </div>
      <div class="login-hint">You'll never guess the password BUMü§£</div>
    </div>
  </div>
</div>

<div class="wallpaper" aria-hidden="true"></div>

<!-- DESKTOP ICONS (UPDATED: absolute, draggable, grid-snapping) -->
<div class="desktop" role="application" aria-label="Desktop icons">
  <div class="desktop-inner" id="desktopInner" tabindex="0">
    <!-- icons will be created & absolutely positioned by JS -->
  </div>
</div>

<!-- Start menu (unchanged earlier) -->
<div id="startMenu" class="start-menu" role="menu" aria-hidden="true" aria-label="Start menu">
  <div class="start-inner">
    <div class="start-left" aria-hidden="false">
      <div class="start-search" role="search">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" style="opacity:0.6"><path d="M21 21l-4.35-4.35" stroke="#234" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/><circle cx="11" cy="11" r="6" stroke="#234" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg>
        <input id="startSearch" placeholder="Type here to search" aria-label="Search" />
      </div>

      <div class="start-profile">
        <div class="profile-pic">TB</div>
        <div>
          <div style="font-weight:700">TheBestAtCoding</div>
          <div style="font-size:12px;color:#4b657a">Account</div>
        </div>
      </div>

      <div class="app-list" id="startAppList" tabindex="0" aria-label="Pinned and installed apps">
        <!-- left app list (sample items) -->
        <div class="app-item"><span style="width:28px;height:28;border-radius:6px;background:linear-gradient(180deg,#c7e0ff,#a6c8ff);display:inline-grid;place-items:center">üì¶</span> 3D Viewer</div>
        <div class="app-item"><span style="width:28px;height:28;border-radius:6px;background:linear-gradient(180deg,#d4f1d4,#a8e6a8);display:inline-grid;place-items:center">üßÆ</span> Calculator</div>
        <div class="app-item"><span style="width:28px;height:28;border-radius:6px;background:linear-gradient(180deg,#f9e7d6,#ffd8b6);display:inline-grid;place-items:center">üìÖ</span> Calendar</div>
        <div class="app-item"><span style="width:28px;height:28;border-radius:6px;background:linear-gradient(180deg,#f0f6ff,#d7e9ff);display:inline-grid;place-items:center">üì∑</span> Camera</div>
        <div class="app-item"><span style="width:28px;height:28;border-radius:6px;background:linear-gradient(180deg,#fff3d6,#ffe1a8);display:inline-grid;place-items:center">üïí</span> Clock</div>
        <div class="app-item"><span style="width:28px;height:28;border-radius:6px;background:linear-gradient(180deg,#e6f3ff,#cfe6ff);display:inline-grid;place-items:center">üîç</span> Cortana</div>
        <div class="app-item"><span style="width:28px;height:28;border-radius:6px;background:linear-gradient(180deg,#fbe6ff,#f3c8ff);display:inline-grid;place-items:center">‚úâÔ∏è</span> Mail</div>
        <div class="app-item"><span style="width:28px;height:28;border-radius:6px;background:linear-gradient(180deg,#e6f7ff,#cfefff);display:inline-grid;place-items:center">üéß</span> Groove Music</div>
        <div class="app-item"><span style="width:28px;height:28;border-radius:6px;background:linear-gradient(180deg,#ffdbe6,#ffbfd6);display:inline-grid;place-items:center">‚öôÔ∏è</span> Settings</div>
      </div>

      <div style="padding-top:8px;">
        <div class="app-item" style="font-size:13px;color:#556b88;justify-content:flex-start">Power</div>
      </div>
    </div>

    <div class="start-right">
      <div style="display:flex;justify-content:space-between;align-items:center;">
        <div style="font-weight:700;font-size:16px">Productivity</div>
        <div style="font-size:13px;color:#4b657a">Pinned</div>
      </div>

      <div class="tiles-grid" role="grid" aria-label="Pinned apps">
        <div class="tile office" role="gridcell" title="Outlook">
          <div class="t-icon">üìß</div>
          <div>Outlook</div>
        </div>
        <div class="tile office" role="gridcell" title="Word">
          <div class="t-icon">W</div>
          <div>Word</div>
        </div>
        <div class="tile office" role="gridcell" title="Excel">
          <div class="t-icon">X</div>
          <div>Excel</div>
        </div>

        <div class="tile edge" role="gridcell" title="OneDrive">
          <div class="t-icon">‚òÅÔ∏è</div>
          <div>OneDrive</div>
        </div>
        <div class="tile office" role="gridcell" title="PowerPoint">
          <div class="t-icon">P</div>
          <div>PowerPoint</div>
        </div>
        <div class="tile" role="gridcell" title="Microsoft To Do" style="background:linear-gradient(180deg,#4b5563,#56607a)">
          <div class="t-icon">‚úì</div>
          <div>To Do</div>
        </div>

        <div class="tile" role="gridcell" title="Office" style="background:linear-gradient(180deg,#d97706,#f59e0b)">
          <div class="t-icon">‚åò</div>
          <div>Office</div>
        </div>
        <div class="tile" role="gridcell" title="Skype" style="background:linear-gradient(180deg,#60a5fa,#3b82f6)">
          <div class="t-icon">S</div>
          <div>Skype</div>
        </div>
        <div class="tile photos" role="gridcell" title="Photos">
          <div class="t-icon">üñºÔ∏è</div>
          <div>Photos</div>
        </div>

        <div class="tile store" role="gridcell" title="Microsoft Store">
          <div class="t-icon">üè¨</div>
          <div>Microsoft Store</div>
        </div>
        <div class="tile spotify" role="gridcell" title="Spotify">
          <div class="t-icon">‚ô™</div>
          <div>Spotify</div>
        </div>
        <div class="tile netflix" role="gridcell" title="Disney+">
          <div class="t-icon">‚òÖ</div>
          <div>Disney+</div>
        </div>
      </div>

      <div class="start-footer">
        <div>All apps</div>
        <div>Quick access</div>
      </div>
    </div>
  </div>
</div>

<!-- Taskbar -->
<div class="taskbar" role="toolbar" aria-label="Taskbar">
  <div class="taskbar-left">
    <div id="startBtn" class="taskbar-icon" title="Start" aria-haspopup="true" aria-expanded="false" role="button">
      <img src="logo.png" width="26" alt="Start">
    </div>
    <!-- pinned icons container -->
    <div id="taskbarPins" style="display:flex;gap:8px;align-items:center;"></div>
    <div id="tb-notes" class="taskbar-icon active" title="Notes">üìù</div>
  </div>
  <div style="margin-left:auto;color:#fff;font-size:13px" id="clock">--:--</div>
</div>

<!-- Notes Window -->
<div id="win-notes" class="window" role="dialog" aria-label="Notes" style="display:flex;">
  <div class="titlebar" data-drag="true">
    <div class="title-left">
      <div class="badge">N</div>
      <div>
        <div style="font-weight:700">Notes</div>
        <div style="font-size:12px;color:#3b556f">Windows 12 notes system</div>
      </div>
    </div>
    <div class="win-controls">
      <div id="notes-min" class="win-btn" title="Minimize">‚Äî</div>
      <div id="notes-full" class="win-btn" title="Fullscreen">‚ñ¢</div>
      <div id="notes-close" class="win-btn" title="Close">‚úï</div>
    </div>
  </div>

  <div class="content">
    <!-- Sidebar -->
    <div class="sidebar" aria-label="Notes list">
      <div class="sb-top">
        <div style="display:flex;align-items:center;justify-content:space-between;">
          <div style="font-weight:700">Winotes</div>
          <div style="font-size:12px;color:#3b556f">Updated</div>
        </div>

        <div style="display:flex;gap:8px;align-items:center">
          <div class="btn primary" id="btn-new" title="New Note">New</div>
          <div class="btn" id="btn-delete" title="Delete Note">Delete</div>
          <div style="flex:1"></div>
        </div>

        <div class="search" style="margin-top:8px">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" style="opacity:0.7"><path d="M21 21l-4.35-4.35" stroke="#223" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/><circle cx="11" cy="11" r="6" stroke="#223" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg>
          <input id="searchInput" placeholder="Search" />
        </div>
      </div>

      <div class="note-list" id="noteList" tabindex="0">
        <!-- notes rendered here -->
      </div>
    </div>

    <!-- Editor -->
    <div class="editor" aria-label="Note editor">
      <div class="editor-toolbar">
        <div style="display:flex;align-items:center;gap:8px">
          <div class="btn" id="btn-lock" title="Lock (toggle)">üîí</div>
          <div class="btn" id="btn-share" title="Share (stub)">üì§</div>
        </div>
        <div style="flex:1"></div>
        <div style="font-size:13px;color:#345">Autosave</div>
      </div>

      <div class="editor-body" id="editorBody">
        <div id="editorInner" style="width:100%;height:100%;display:flex;flex-direction:column;min-height:0">
          <input id="noteTitle" class="note-title-input" placeholder="Title" />
          <textarea id="noteText" class="note-textarea" placeholder="Start typing your note..." ></textarea>
        </div>
      </div>
    </div>
  </div>

  <div class="resizer" id="notesResizer"></div>
</div>

<script>
/* MAIN SCRIPT - updated desktop dragging to allow free placement with grid snapping.
   All other behavior preserved.
*/
(function(){
  // LOGIN elements
  const loginScreen = document.getElementById('loginScreen');
  const pinInput = document.getElementById('pinInput');
  const pinSubmit = document.getElementById('pinSubmit');
  const pinCancel = document.getElementById('pinCancel');

  // Desktop elements
  const desktopInner = document.getElementById('desktopInner');

  // Context menu elements
  const ctxMenu = document.getElementById('ctxMenu');
  const ctxOpen = document.getElementById('ctxOpen');
  const ctxPin = document.getElementById('ctxPin');

  // Taskbar pins container
  const taskbarPinsEl = document.getElementById('taskbarPins');

  // Existing elements
  const tbNotes = document.getElementById('tb-notes');
  const winNotes = document.getElementById('win-notes');
  const noteListEl = document.getElementById('noteList');
  const btnNew = document.getElementById('btn-new');
  const btnDelete = document.getElementById('btn-delete');
  const searchInput = document.getElementById('searchInput');
  const noteTitleEl = document.getElementById('noteTitle');
  const noteTextEl = document.getElementById('noteText');
  const notesResizer = document.getElementById('notesResizer');
  const notesMin = document.getElementById('notes-min');
  const notesClose = document.getElementById('notes-close');
  const notesFull = document.getElementById('notes-full');
  const clockEl = document.getElementById('clock');
  const btnLock = document.getElementById('btn-lock');
  const editorInner = document.getElementById('editorInner');
  const editorBody = document.getElementById('editorBody');

  const startBtn = document.getElementById('startBtn');
  const startMenu = document.getElementById('startMenu');
  const startSearch = document.getElementById('startSearch');

  const STORAGE_KEY = 'notes_app_v1';
  const DESKTOP_POS_KEY = 'desktop_positions_v1';
  const PINNED_KEY = 'pinned_apps_v1';

  // App state
  let notes = []; // {id, title, body, updated}
  let selectedId = null;
  let filter = '';
  let locked = false;

  // Desktop icon list (you can add more)
  const defaultDesktopItems = [
    { id: 'notes', title: 'Notes', icon: 'üìù', action: 'open-notes' },
    { id: 'recycle', title: 'Recycle Bin', icon: 'üóëÔ∏è', action: 'noop' }
  ];

  // position map loaded/saved
  let desktopPositions = {}; // { id: {x, y} }
  let desktopItems = JSON.parse(JSON.stringify(defaultDesktopItems)); // items array
  let pinnedApps = [];

  // Grid config (matches icon size)
  const CELL_W = 96;
  const CELL_H = 110;
  const PADDING = 32;
  const GAP_X = 18;
  const GAP_Y = 0; // vertical gap previously implicit; we keep cell height large enough

  // load pinned & positions from storage
  function loadPersisted(){
    try {
      const pos = JSON.parse(localStorage.getItem(DESKTOP_POS_KEY) || 'null');
      if (pos && typeof pos === 'object') desktopPositions = pos;
    } catch(e){ desktopPositions = {}; }
    try { pinnedApps = JSON.parse(localStorage.getItem(PINNED_KEY) || 'null') || []; } catch(e){ pinnedApps = []; }
  }

  loadPersisted();

  // REQUIRED PIN (exact)
  const REQUIRED_PIN = 'imthebest';

  // Utility: compute grid columns count
  function computeGridCols(){
    const rect = desktopInner.getBoundingClientRect();
    const availableWidth = Math.max(0, rect.width - (PADDING * 2));
    const colWidth = CELL_W + GAP_X;
    const cols = Math.max(1, Math.floor((availableWidth + GAP_X) / colWidth));
    return cols;
  }

  // Utility: convert index -> x,y within grid (for initial auto-layout)
  function gridPositionForIndex(i){
    const cols = computeGridCols();
    const col = i % cols;
    const row = Math.floor(i / cols);
    const x = PADDING + col * (CELL_W + GAP_X);
    const y = PADDING + row * (CELL_H + GAP_Y);
    return { x, y };
  }

  // Snap arbitrary x,y to nearest grid cell (clamped within desktop)
  function snapToGrid(x, y){
    const rect = desktopInner.getBoundingClientRect();
    const cols = computeGridCols();
    const colWidth = CELL_W + GAP_X;
    const rowHeight = CELL_H + GAP_Y;
    // relative to desktop padding origin
    let rx = x - rect.left - PADDING;
    let ry = y - rect.top - PADDING;
    // compute nearest cell
    let col = Math.round(rx / colWidth);
    let row = Math.round(ry / rowHeight);
    // clamp
    col = Math.max(0, Math.min(cols - 1, col));
    const maxRows = Math.max(1, Math.floor((rect.height - PADDING*2 + GAP_Y) / rowHeight));
    row = Math.max(0, Math.min(maxRows - 1, row));
    const nx = PADDING + col * colWidth;
    const ny = PADDING + row * rowHeight;
    return { x: nx, y: ny };
  }

  // Render desktop icons as absolutely positioned elements
  function renderDesktop(){
    if (!desktopInner) return;
    desktopInner.innerHTML = '';
    desktopItems.forEach((it, idx) => {
      const node = document.createElement('div');
      node.className = 'icon';
      node.setAttribute('data-id', it.id);
      node.setAttribute('tabindex', '0');
      node.innerHTML = `<div class="ico" aria-hidden="true">${it.icon}</div><div class="label">${it.title}</div>`;
      // compute position: use saved position if available, else auto grid position
      const pos = desktopPositions[it.id] || gridPositionForIndex(idx);
      node.style.left = (pos.x) + 'px';
      node.style.top = (pos.y) + 'px';
      desktopInner.appendChild(node);

      // selection & double-click to open
      let clickTimer = null;
      node.addEventListener('click', (e)=>{
        e.stopPropagation();
        clearSelections();
        node.classList.add('selected');
        if (clickTimer){
          clearTimeout(clickTimer); clickTimer = null;
          handleDesktopAction(it);
        } else {
          clickTimer = setTimeout(()=> { clearTimeout(clickTimer); clickTimer = null; }, 300);
        }
      });

      // keyboard open
      node.addEventListener('keydown', (e)=>{
        if (e.key === 'Enter') handleDesktopAction(it);
      });

      // right-click context menu
      node.addEventListener('contextmenu', (e)=>{
        e.preventDefault();
        e.stopPropagation();
        showContextMenuFor(it, e.clientX, e.clientY);
      });

      // pointer-based dragging (works for mouse & touch)
      let dragging = false;
      let startX = 0, startY = 0;
      let origLeft = 0, origTop = 0;

      function pointerDown(ev){
        if (isLocked()) { focusPin(); return; }
        ev.preventDefault();
        dragging = true;
        node.classList.add('dragging');
        // unify touch and mouse
        const p = ev.touches ? ev.touches[0] : ev;
        startX = p.clientX; startY = p.clientY;
        const r = node.getBoundingClientRect();
        // compute offsets relative to desktopInner's left/top
        origLeft = r.left - desktopInner.getBoundingClientRect().left;
        origTop = r.top - desktopInner.getBoundingClientRect().top;
        // raise z
        node.style.zIndex = 2000;
        // add move/up listeners on window
        window.addEventListener('pointermove', pointerMove);
        window.addEventListener('pointerup', pointerUp, { once: true });
        // also handle touchmove/touchend for broader compatibility
        window.addEventListener('touchmove', pointerMove, { passive: false });
        window.addEventListener('touchend', pointerUp, { once: true });
      }
      function pointerMove(ev){
        if (!dragging) return;
        ev.preventDefault();
        const p = ev.touches ? ev.touches[0] : ev;
        const dx = p.clientX - startX;
        const dy = p.clientY - startY;
        const nx = origLeft + dx;
        const ny = origTop + dy;
        // set immediate free position (no snapping while dragging)
        node.style.left = Math.max(0, nx) + 'px';
        node.style.top = Math.max(0, ny) + 'px';
      }
      function pointerUp(ev){
        if (!dragging) return;
        dragging = false;
        node.classList.remove('dragging');
        // compute absolute screen coords for snapping
        const r = node.getBoundingClientRect();
        const snapped = snapToGrid(r.left, r.top);
        // apply snapped position relative to desktopInner
        node.style.left = (snapped.x) + 'px';
        node.style.top = (snapped.y) + 'px';
        node.style.zIndex = '';
        // save position
        desktopPositions[it.id] = { x: snapped.x, y: snapped.y };
        persistDesktopPositions();
        // cleanup listeners (some may be removed via once)
        window.removeEventListener('pointermove', pointerMove);
        window.removeEventListener('pointerup', pointerUp);
        window.removeEventListener('touchmove', pointerMove);
        window.removeEventListener('touchend', pointerUp);
      }

      // pointerdown (mouse & touch)
      node.addEventListener('pointerdown', pointerDown);
      node.addEventListener('touchstart', pointerDown, { passive: false });
    });
  }

  function clearSelections(){
    document.querySelectorAll('.desktop .icon.selected').forEach(n=>n.classList.remove('selected'));
  }
  document.addEventListener('click', (e)=> {
    if (!e.target.closest('.desktop .icon')) clearSelections();
  });

  // open action
  function handleDesktopAction(item){
    if (item.action === 'open-notes'){
      winNotes.style.display = 'flex';
      bringToFront(winNotes);
    } else {
      // noop
    }
  }

  // Context menu wiring
  let ctxTargetItem = null;
  function showContextMenuFor(item, x, y){
    ctxTargetItem = item;
    const isPinned = pinnedApps.includes(item.id);
    ctxPin.textContent = isPinned ? 'Unpin from taskbar' : 'Pin to taskbar';
    ctxMenu.style.left = x + 'px';
    ctxMenu.style.top = y + 'px';
    ctxMenu.style.display = 'block';
    ctxMenu.setAttribute('aria-hidden','false');
    requestAnimationFrame(()=> {
      const r = ctxMenu.getBoundingClientRect();
      if (r.right > window.innerWidth) ctxMenu.style.left = (window.innerWidth - r.width - 12) + 'px';
      if (r.bottom > window.innerHeight) ctxMenu.style.top = (window.innerHeight - r.height - 12) + 'px';
    });
  }
  function hideContextMenu(){
    ctxMenu.style.display = 'none';
    ctxMenu.setAttribute('aria-hidden','true');
    ctxTargetItem = null;
  }
  ctxOpen.addEventListener('click', ()=>{
    if (ctxTargetItem) handleDesktopAction(ctxTargetItem);
    hideContextMenu();
  });
  ctxPin.addEventListener('click', ()=>{
    if (!ctxTargetItem) return hideContextMenu();
    togglePin(ctxTargetItem.id);
    hideContextMenu();
  });
  document.addEventListener('click', (e)=>{
    if (!ctxMenu.contains(e.target)) hideContextMenu();
  });
  window.addEventListener('keydown', (e)=>{
    if (e.key === 'Escape') hideContextMenu();
  });

  // Pin/unpin logic
  function togglePin(id){
    const idx = pinnedApps.indexOf(id);
    if (idx === -1){
      pinnedApps.push(id);
    } else {
      pinnedApps.splice(idx,1);
    }
    persistPinned();
    renderTaskbarPins();
  }
  function persistPinned(){
    try { localStorage.setItem(PINNED_KEY, JSON.stringify(pinnedApps)); } catch(e){}
  }
  function renderTaskbarPins(){
    taskbarPinsEl.innerHTML = '';
    pinnedApps.forEach(id=>{
      const item = desktopItems.find(x=>x.id===id) || defaultDesktopItems.find(x=>x.id===id);
      if (!item) return;
      const el = document.createElement('div');
      el.className = 'taskbar-pin';
      el.setAttribute('title', item.title);
      el.setAttribute('data-id', item.id);
      el.innerHTML = `<div style="width:28px;height:28;display:grid;place-items:center">${item.icon}</div>`;
      el.addEventListener('click', ()=> {
        if (item.action === 'open-notes') {
          winNotes.style.display = 'flex';
          bringToFront(winNotes);
        }
      });
      el.addEventListener('contextmenu', (e)=>{
        e.preventDefault();
        e.stopPropagation();
        showContextMenuFor(item, e.clientX, e.clientY);
      });
      taskbarPinsEl.appendChild(el);
    });
  }

  // persist positions
  function persistDesktopPositions(){
    try { localStorage.setItem(DESKTOP_POS_KEY, JSON.stringify(desktopPositions)); } catch(e){}
  }

  // Focus helper
  function focusPin(){ if(pinInput) { pinInput.focus(); pinInput.select(); } }

  // Show/hide login (login shows by default)
  function hideLogin(){
    if (loginScreen) loginScreen.style.display = 'none';
    document.body.classList.remove('locked'); // reveal UI immediately and prevent flash
    // after unlocking, ensure wallpaper is visible (it already is) and focus notes if open
    if (getComputedStyle(winNotes).display !== 'none'){
      noteTextEl.focus();
    }
  }
  function showLogin(){
    if (loginScreen) loginScreen.style.display = 'flex';
    document.body.classList.add('locked');
    setTimeout(()=> focusPin(), 60);
  }

  // Check PIN
  function checkPin(){
    if (!pinInput) return;
    const v = pinInput.value || '';
    if (v === REQUIRED_PIN){
      hideLogin();
    } else {
      pinInput.value = '';
      pinInput.placeholder = 'Fricking Loser';
      if (loginScreen && loginScreen.animate){
        loginScreen.animate([{transform:'translateY(0)'},{transform:'translateY(-6px)'},{transform:'translateY(0)'}], {duration:220, easing:'cubic-bezier(.2,.9,.2,1)'});
      }
      setTimeout(()=> { pinInput.placeholder = 'PIN'; focusPin(); }, 800);
    }
  }

  // attach login handlers
  if (pinSubmit) pinSubmit.addEventListener('click', checkPin);
  if (pinCancel) pinCancel.addEventListener('click', ()=>{
    if (!pinInput) return;
    pinInput.value = '';
    focusPin();
  });
  if (pinInput){
    pinInput.addEventListener('keydown', (e)=>{
      if (e.key === 'Enter') checkPin();
      else if (e.key === 'Escape'){ pinInput.value=''; }
    });
  }

  // Initially show login
  showLogin();

  // Prevent interacting with background while signed out
  function isLocked(){ return loginScreen && getComputedStyle(loginScreen).display !== 'none'; }

  // START MENU handlers
  function openStartMenu(){
    if (isLocked()) { focusPin(); return; }
    startMenu.style.display = 'block';
    startMenu.setAttribute('aria-hidden','false');
    startBtn.setAttribute('aria-expanded','true');
    setTimeout(()=> startSearch.focus(), 60);
  }
  function closeStartMenu(){
    startMenu.style.display = 'none';
    startMenu.setAttribute('aria-hidden','true');
    startBtn.setAttribute('aria-expanded','false');
    startBtn.focus();
  }
  startBtn.addEventListener('click', (e)=>{
    e.stopPropagation();
    if (isLocked()) { focusPin(); return; }
    if (startMenu.style.display === 'block') closeStartMenu();
    else openStartMenu();
  });
  document.addEventListener('click', (e)=>{
    if (startMenu.style.display !== 'block') return;
    if (!startMenu.contains(e.target) && !startBtn.contains(e.target)) closeStartMenu();
  });
  startMenu.addEventListener('click', (e)=> e.stopPropagation());
  startSearch.addEventListener('input', (e)=>{
    const q = e.target.value.trim().toLowerCase();
    const items = document.querySelectorAll('#startAppList .app-item');
    items.forEach(it=>{
      it.style.display = (!q || it.textContent.toLowerCase().includes(q)) ? 'flex' : 'none';
    });
  });

  // Notes app logic (unchanged)
  function uid(){ return Date.now().toString(36) + Math.random().toString(36).slice(2,9); }
  function now(){ return Date.now(); }
  function formatTime(ts){ const d=new Date(ts); return d.toLocaleString([], {hour:'2-digit',minute:'2-digit',month:'short',day:'numeric'}); }
  function saveAll(){ try { localStorage.setItem(STORAGE_KEY, JSON.stringify(notes)); } catch(e){} }
  function loadAll(){ try { const s = localStorage.getItem(STORAGE_KEY); notes = s ? JSON.parse(s) : []; } catch(e){ notes=[]; } }

  function renderList(){
    const q = filter.trim().toLowerCase();
    const list = notes
      .slice()
      .filter(n => {
        if (!q) return true;
        return (n.title || '').toLowerCase().includes(q) || (n.body || '').toLowerCase().includes(q);
      })
      .sort((a,b)=> b.updated - a.updated);
    noteListEl.innerHTML = '';
    if (list.length === 0){
      noteListEl.innerHTML = '<div style="padding:14px;color:#66799a">No notes yet ‚Äî click New to create one.</div>';
      return;
    }
    list.forEach(n=>{
      const item = document.createElement('div');
      item.className = 'note-item' + (n.id === selectedId ? ' active' : '');
      item.setAttribute('data-id', n.id);
      const title = document.createElement('div');
      title.className = 'note-title';
      title.textContent = n.title || 'Untitled';
      const snippet = document.createElement('div');
      snippet.className = 'note-snippet';
      snippet.textContent = (n.body || '').split('\n').join(' ').slice(0,120);
      const meta = document.createElement('div');
      meta.className = 'note-meta';
      meta.textContent = formatTime(n.updated);
      item.appendChild(title);
      item.appendChild(snippet);
      item.appendChild(meta);
      item.addEventListener('click', ()=> {
        if (isLocked()){ focusPin(); return; }
        selectNote(n.id);
      });
      noteListEl.appendChild(item);
    });
  }

  function selectNote(id){
    const n = notes.find(x=>x.id===id);
    if (!n) return;
    selectedId = id;
    noteTitleEl.value = n.title || '';
    noteTextEl.value = n.body || '';
    renderList();
    focusEditor();
  }

  function createNote(){
    if (isLocked()){ focusPin(); return; }
    const id = uid();
    const n = { id, title:'', body:'', updated: now() };
    notes.push(n);
    saveAll();
    selectedId = id;
    renderList();
    selectNote(id);
    focusTitle();
  }

  function deleteSelected(){
    if (isLocked()){ focusPin(); return; }
    if (!selectedId) return alert('No note selected to delete.');
    const idx = notes.findIndex(n=>n.id===selectedId);
    if (idx === -1) return;
    const confirmDel = confirm('Delete this note? This action cannot be undone.');
    if (!confirmDel) return;
    notes.splice(idx,1);
    selectedId = notes.length ? notes[0].id : null;
    saveAll();
    renderList();
    if (selectedId) selectNote(selectedId);
    else { noteTitleEl.value=''; noteTextEl.value=''; }
  }

  let saveTimer = null;
  function scheduleSave(){
    if (isLocked()){ focusPin(); return; }
    if (!selectedId) return;
    if (saveTimer) clearTimeout(saveTimer);
    saveTimer = setTimeout(() => {
      const n = notes.find(x=>x.id===selectedId);
      if (!n) return;
      n.title = noteTitleEl.value;
      n.body = noteTextEl.value;
      n.updated = now();
      saveAll();
      renderList();
    }, 450);
  }

  function focusEditor(){ noteTextEl.focus(); }
  function focusTitle(){ noteTitleEl.focus(); noteTitleEl.select(); }

  searchInput.addEventListener('input', (e)=>{ filter = e.target.value; renderList(); });
  btnNew.addEventListener('click', createNote);
  btnDelete.addEventListener('click', deleteSelected);
  noteTitleEl.addEventListener('input', scheduleSave);
  noteTextEl.addEventListener('input', scheduleSave);

  window.addEventListener('keydown', (e)=>{
    if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'n') {
      e.preventDefault();
      createNote();
    }
    if (e.key === 'Escape'){
      if (startMenu.style.display === 'block') closeStartMenu();
      else { searchInput.blur(); noteTextEl.blur(); noteTitleEl.blur(); }
    }
  });

  // Lock button behavior
  function setLocked(state){
    locked = !!state;
    if (locked){
      editorInner.classList.add('editor-locked');
      noteTitleEl.readOnly = true;
      noteTextEl.readOnly = true;
      btnLock.style.opacity = '0.75';
    } else {
      editorInner.classList.remove('editor-locked');
      noteTitleEl.readOnly = false;
      noteTextEl.readOnly = false;
      btnLock.style.opacity = '';
    }
  }
  btnLock.addEventListener('click', ()=> { setLocked(!locked); });

  // Resizing notes window
  (function makeResizable(){
    let resizing=false, startX=0,startY=0,startW=0,startH=0;
    const res = notesResizer;
    res.addEventListener('mousedown', (ev)=>{
      if (winNotes.classList.contains('fullscreen')) return;
      if (isLocked()){ focusPin(); return; }
      resizing = true; startX = ev.clientX; startY = ev.clientY;
      const rect = winNotes.getBoundingClientRect();
      startW = rect.width; startH = rect.height;
      ev.preventDefault();
    });
    window.addEventListener('mousemove', (ev)=>{
      if (!resizing) return;
      const dx = ev.clientX - startX, dy = ev.clientY - startY;
      winNotes.style.width = Math.max(520, startW + dx) + 'px';
      winNotes.style.height = Math.max(300, startH + dy) + 'px';
    });
    window.addEventListener('mouseup', ()=> resizing=false);
  })();

  // Draggable titlebar
  (function makeDraggable(){
    const header = winNotes.querySelector('[data-drag="true"]');
    let dragging=false, sx=0, sy=0, ox=0, oy=0;
    header.addEventListener('mousedown', (e)=>{
      if (winNotes.classList.contains('fullscreen')) return;
      if (isLocked()){ focusPin(); return; }
      dragging = true;
      sx = e.clientX; sy = e.clientY;
      const r = winNotes.getBoundingClientRect();
      ox = r.left; oy = r.top;
      header.style.cursor = 'grabbing';
    });
    window.addEventListener('mousemove', (e)=>{
      if (!dragging) return;
      const dx = e.clientX - sx, dy = e.clientY - sy;
      winNotes.style.left = Math.max(8, ox + dx) + 'px';
      winNotes.style.top = Math.max(8, oy + dy) + 'px';
    });
    window.addEventListener('mouseup', ()=> { dragging=false; header.style.cursor='grab'; });
  })();

  // Minimize/close buttons
  notesMin.addEventListener('click', ()=> {
    if (isLocked()){ focusPin(); return; }
    winNotes.style.display='none';
  });
  notesClose.addEventListener('click', ()=> {
    if (isLocked()){ focusPin(); return; }
    if (confirm('Close notes window?')) winNotes.style.display='none';
  });

  // Fullscreen toggle
  function toggleFullscreen(){
    if (isLocked()){ focusPin(); return; }
    if (!winNotes.classList.contains('fullscreen')){
      const prev = {
        left: winNotes.style.left || '',
        top: winNotes.style.top || '',
        width: winNotes.style.width || '',
        height: winNotes.style.height || '',
        borderRadius: winNotes.style.borderRadius || ''
      };
      try { winNotes.dataset.prev = JSON.stringify(prev); } catch(e){}
      winNotes.classList.add('fullscreen');
      winNotes.style.left = '';
      winNotes.style.top = '';
      winNotes.style.width = '';
      winNotes.style.height = '';
      winNotes.style.borderRadius = '0';
    } else {
      try {
        const prev = winNotes.dataset.prev ? JSON.parse(winNotes.dataset.prev) : null;
        if (prev){
          winNotes.style.left = prev.left || '';
          winNotes.style.top = prev.top || '';
          winNotes.style.width = prev.width || '';
          winNotes.style.height = prev.height || '';
          winNotes.style.borderRadius = prev.borderRadius || '';
        }
      } catch(e){}
      winNotes.classList.remove('fullscreen');
    }
  }
  notesFull.addEventListener('click', toggleFullscreen);
  const titleBar = winNotes.querySelector('.titlebar');
  titleBar.addEventListener('dblclick', ()=> toggleFullscreen());

  // Bring to front when clicking window
  winNotes.addEventListener('mousedown', ()=> bringToFront(winNotes));
  let topZ = 40;
  function bringToFront(el){ topZ += 1; el.style.zIndex = topZ; }

  // Startup: load notes, render, select first if exists
  loadAll();
  if (notes.length > 0) {
    notes.sort((a,b)=> b.updated - a.updated);
    selectedId = notes[0].id;
    renderList();
    selectNote(selectedId);
  } else {
    renderList();
    selectedId = null;
    noteTitleEl.value = '';
    noteTextEl.value = '';
  }

  // Load persisted desktop items & positions & pins, then render
  (function initDesktopState(){
    // keep items order same as default (no reordering since free placement)
    desktopItems = JSON.parse(JSON.stringify(defaultDesktopItems));
    // Ensure any existing desktopPositions keys that reference non-existent items are ignored
    const saved = JSON.parse(localStorage.getItem(DESKTOP_POS_KEY) || 'null') || {};
    desktopPositions = saved;
    pinnedApps = JSON.parse(localStorage.getItem(PINNED_KEY) || 'null') || pinnedApps || [];
    renderDesktop();
    renderTaskbarPins();
  })();

  // Clock update
  function updateClock(){ const d=new Date(); clockEl.textContent = d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}); }
  updateClock(); setInterval(updateClock, 30*1000);

  // Clicking taskbar notes icon toggles window
  tbNotes.addEventListener('click', ()=> {
    if (isLocked()){ focusPin(); return; }
    if (getComputedStyle(winNotes).display === 'none') { winNotes.style.display='flex'; bringToFront(winNotes); }
    else { winNotes.style.display='none'; }
  });

  // Protect launch of start/menu items while locked: intercept tile/app clicks (simple)
  document.addEventListener('click', function(e){
    if (isLocked()){
      if (!loginScreen.contains(e.target)) {
        focusPin();
      }
    }
  }, true);

  // accessibility: keyboard support for desktopInner
  desktopInner.addEventListener('keydown', (e)=>{
    if (e.key === 'Enter'){
      const focused = document.activeElement;
      if (focused && focused.classList.contains('icon')){
        const id = focused.getAttribute('data-id');
        const item = desktopItems.find(x=>x.id===id);
        if (item) handleDesktopAction(item);
      }
    }
  });

  // Keep desktop responsive: when window resizes, re-snap any icons that are out-of-bounds
  window.addEventListener('resize', ()=> {
    // ensure icons still within grid; if saved positions exist, clamp them
    const rect = desktopInner.getBoundingClientRect();
    const cols = computeGridCols();
    const maxRows = Math.max(1, Math.floor((rect.height - PADDING*2 + GAP_Y) / (CELL_H + GAP_Y)));
    Object.keys(desktopPositions).forEach(id => {
      let pos = desktopPositions[id];
      if (!pos) return;
      // compute nearest col/row for current pos
      let relX = pos.x - PADDING;
      let relY = pos.y - PADDING;
      const colWidth = CELL_W + GAP_X;
      const rowHeight = CELL_H + GAP_Y;
      let col = Math.round(relX / colWidth);
      let row = Math.round(relY / rowHeight);
      col = Math.max(0, Math.min(cols - 1, col));
      row = Math.max(0, Math.min(maxRows - 1, row));
      desktopPositions[id] = { x: PADDING + col * colWidth, y: PADDING + row * rowHeight };
    });
    persistDesktopPositions();
    renderDesktop();
  });

})();
</script>

</body>
</html>

